# Jamfile for src/system/kernel/alloc

SubDir HAIKU_TOP src system kernel alloc ;

UsePrivateHeaders kernel ; # For kernel-specific headers if PAL needs more

# Default to slab, but allow override (e.g., from a build profile)
# For testing, you can uncomment and set this locally:
# HAIKU_KERNEL_ALLOCATOR ?= snmalloc ;
# HAIKU_KERNEL_ALLOCATOR ?= slab ; # Original default
HAIKU_KERNEL_ALLOCATOR = snmalloc ; # Force snmalloc for kernel

local allocatorObjects ;
local allocatorDefines ;

if $(HAIKU_KERNEL_ALLOCATOR) = snmalloc {
    Echo Kernel Allocator: snmalloc (using local sources from libroot area) ;

    # Define path to the new shared snmalloc source directory
    local newSnmallocSourceBaseDir = src/system/libroot/posix/malloc/snmalloc ;

    SubDirC++Flags
        # REMOVE: -I$(HAIKU_TOP)/BSD/snmalloc-main/src
        # REMOVE: -I$(SUBDIR)/snmalloc
        # ADD: Include path to the new shared snmalloc directory
        # This allows #include "snmalloc/file.h" and #include "pal/file.h"
        # from snmalloc_kernel_api.cpp if it's also in newSnmallocSourceBaseDir.
        -I$(HAIKU_TOP)/$(newSnmallocSourceBaseDir)
    ;

    local snmallocTargetFlags = ; # These flags are specific to snmalloc compilation
    # Add snmalloc hardening flags
    snmallocTargetFlags += -DSNMALLOC_CHECK_CLIENT=1 -DSNMALLOC_PAGEID=1 -DSNMALLOC_CHECK_LOADS=1 ;
    # Optional: Enable verbose tracing within snmalloc
    # snmallocTargetFlags += -DSNMALLOC_TRACING=1 ;
    # Optional: Enable statistics gathering within snmalloc
    # snmallocTargetFlags += -DSNMALLOC_STATS=1 ;
    # Optional: Enable specific advanced security mitigations (can be combined with +)
    # See snmalloc/CMakeLists.txt for full list. Examples:
    # snmallocTargetFlags += -DSNMALLOC_CHECK_CLIENT_MITIGATIONS="metadata_protection" ;
    # snmallocTargetFlags += -DSNMALLOC_CHECK_CLIENT_MITIGATIONS="freelist_forward_edge" ;
    # snmallocTargetFlags += -DSNMALLOC_CHECK_CLIENT_MITIGATIONS="random_pagemap" ;
    # Note: Some mitigations like 'pal_enforce_access' require specific PAL support.
   
    # Target specific flags
    # Source path is now relative to HAIKU_TOP, pointing to the shared location
    KernelMergeObject snmalloc_kernel_api.o :
        $(HAIKU_TOP)/$(newSnmallocSourceBaseDir)/snmalloc_kernel_api.cpp # New path
        : 
        $(snmallocTargetFlags)
    ;
    allocatorObjects = snmalloc_kernel_api.o ;

    # The -DKERNEL_ALLOCATOR_SNMALLOC define is now handled by the parent src/system/kernel/Jamfile
    # to ensure it's globally visible for kernel compilations when snmalloc is active.
    # This Jamfile only needs to worry about flags specific to snmalloc_kernel_api.o compilation.

} else {
    # Default to slab allocator (or any other chosen default)
    Echo Kernel Allocator: slab ;
    # The slab allocator is currently built via src/system/kernel/slab/Jamfile
    # and its objects are directly included in src/system/kernel/Jamfile.
    # This Jamfile (alloc/Jamfile) will produce an empty kernel_allocator.o
    # in this case, or we can make src/system/kernel/Jamfile conditional
    # on kernel_slab.o vs kernel_allocator.o from here.

    # For now, this Jamfile won't produce conflicting symbols if slab is default.
    # If this Jamfile *must* provide the 'kernel_allocator.o' target,
    # we'd do something like this:
    # KernelMergeObject slab_dummy.o : empty.cpp ; # Assuming an empty.cpp
    # allocatorObjects = slab_dummy.o ;
    # However, it's cleaner to adjust src/system/kernel/Jamfile to pick one.
}

# This object will be conditionally included in the main kernel link
# based on the allocator choice.
# If allocatorObjects is empty (e.g. slab is handled by its own Jamfile),
# then this target might not be strictly necessary, or kernel/Jamfile
# needs to be aware.
if $(allocatorObjects) {
    KernelMergeObject kernel_allocator.o :
        $(allocatorObjects)
    ;
    # If defines were set:
    # SubDirCcFlags $(allocatorDefines) ;
    # SubDirC++Flags $(allocatorDefines) ;
}

